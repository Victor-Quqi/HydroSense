## **HydroSense 项目软件架构总纲**

#### **最终目标**

创建一个架构清晰、功能可靠、易于扩展的能量自持型智能浇水系统固件。该固件以稳定运行为基石，通过模块化设计实现对硬件的精确控制和对环境的智能响应，同时为未来的低功耗深度优化预留清晰的接口。

#### **设计原则**

1.  **模块化驱动，职责单一 (Module-Driven, Single Responsibility)**
    系统被划分为一系列高内聚、低耦合的独立模块。每个模块都有明确且唯一的职责，通过公开的头文件 (`.h`) 提供服务接口。严禁模块之间"跨界"直接访问私有数据或硬件。
    *   **硬件抽象层 (HAL):** 唯一可以直接操作 GPIO 和硬件外设的模块。
    *   **管理器层 (Managers/Controllers):** 负责业务逻辑。
    *   **系统层 (System):** 负责状态机和事件处理。
    *   **数据层 (Data):** 负责共享数据结构和配置。
    *   **测试层 (Test):** 负责硬件在环测试和CLI接口。
    *   **主控层 (Main):** 负责初始化所有模块并协调它们之间的交互。

2.  **硬件抽象，隔离变化 (Hardware Abstraction, Isolate Change)**
    所有业务逻辑代码（管理器层）都必须通过硬件抽象层 (HAL) 与物理硬件交互。业务逻辑不应关心传感器连接在哪个 ADC 通道，或水泵由哪个 GPIO 控制。这种隔离使得更换硬件或调整引脚时，只需修改 HAL 模块，上层代码无需变动。

3.  **状态机驱动，逻辑清晰 (State Machine Driven, Clear Logic)**
    系统的核心行为由一个明确的状态机来管理。系统的状态（如 `IDLE_SLEEPING`, `SENSING`, `WATERING`, `CONFIGURING`）被显式定义。代码的执行流不再是复杂的 `if/else` 嵌套，而是清晰的状态转换逻辑。主循环的核心任务就是检查当前状态，执行该状态下的任务，并根据事件决定是否转换到下一个状态。

4.  **事件驱动，主循环决策 (Event-Driven, Main-Loop Decision)**
    这是系统稳定性的基石。所有来自异步或高优先级上下文的"事件"（如 RTC 定时器唤醒、旋转编码器引脚中断）**仅设置事件标志位 (flag)**，绝不执行耗时操作。所有实际的逻辑处理、状态转换和硬件操作，都必须在主循环 (`loop()`) 的安全上下文中，根据检测到的标志位来统一决策和执行。这从架构上避免了竞态条件的发生。

5.  **接口先行，松散耦合 (Interface-First, Loose Coupling)**
    在实现任何一个模块的具体功能 (`.cpp`) 之前，优先定义其对外服务的头文件 (`.h`)。思考"这个模块需要为其他模块提供什么能力？"，而不是"这个模块内部要怎么实现？"。模块间的数据交换应通过定义在公共头文件（如 `DataModels.h` 或 `SystemState.h`）中的结构体进行，避免直接依赖彼此的内部实现细节。

6.  **测试驱动，硬件在环 (Test-Driven, Hardware-in-Loop)**
    系统设计支持轻量级的硬件在环测试策略。通过编译时宏 (`#ifdef TEST_MODE`) 启用专门的测试模式，提供串口CLI接口用于：
    *   **状态查询**: 获取设备状态快照和传感器数据
    *   **硬件控制**: 直接控制电源门、执行器等硬件
    *   **输入模拟**: 模拟传感器读数，测试各种场景
    *   **逻辑触发**: 手动触发ULP和主CPU的决策逻辑
    所有测试代码与生产代码完全隔离，确保发布版固件的纯净性。

---

## 项目开发路线图

### 阶段一：平台验证与 `OFF` 模式
- [ ] 实现：基础硬件抽象层 (HAL) 与 CLI 测试框架
- [ ] 实现：`OFF` 模式 (安全休眠与关机界面)
- [ ] 实现：基础日志系统 (支持分级串口输出)
- [ ] 完成：所有硬件模块的端到端验证

### 阶段二：自主运行 `RUN` 模式
- [ ] 实现：“哨兵-指挥官”低功耗架构
- [ ] 实现：核心自动浇水业务逻辑
- [ ] 实现：`RUN` 模式的状态仪表盘显示

### 阶段三：人机交互 `INTERACTIVE` 模式
- [ ] 实现：基于编码器的菜单系统框架
- [ ] 实现：核心交互功能 (参数设置、历史数据查看、手动控制)
- [ ] 实现：关键事件日志的持久化存储与查看

### 阶段四：云端智能与完善
- [ ] 实现：Wi-Fi 连接与 NTP 时间同步
- [ ] 实现：为日志系统集成精确时间戳
- [ ] 实现：“AI健康报告”功能 (LLM 集成)
- [ ] 完成：系统最终优化与稳定性测试