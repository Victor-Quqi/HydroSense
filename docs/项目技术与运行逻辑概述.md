## **项目：HydroSense - 能量自持型智能浇水系统**

### **项目技术与运行逻辑概述**

#### **项目愿景与设计哲学**

HydroSense 旨在成为一个能够实现**能量自持 (Energy Self-Sufficient)**、达成“永久续航”级别的智能植物养护终端。其设计哲学融合了**极致的低功耗**与**高效的能量采集**，通过“哨兵-指挥官”协同架构将系统待机功耗降至微安级，同时利用模块化的太阳能系统在后台静默地补充能量，形成一个完美的能量闭环。

#### **核心技术架构**

1.  **“哨兵-指挥官”双处理器协同 (ULP & Main CPU):**
    *   系统的核心运行模式。**指挥官 (Main CPU)** 默认沉睡，**哨兵 (ULP)** 以纳瓦级功耗周期性巡逻，仅在必要时唤醒指挥官，从根本上杜绝了待机状态下的能源浪费。

2.  **鲁棒的启动与故障安全设计 (Robust Startup & Fault-Safe Design):**
    *   这是本设计的关键亮点。通过为所有P-MOSFET电源开关配备**~2kΩ的强上拉电阻**，我们确保了在MCU上电初始化的数百毫秒“空窗期”内，能够强制覆盖ESP32引脚约1.05V的默认弱低电平状态。这保证了所有受控外设（特别是12V升压模块）在上电瞬间**绝对处于关闭状态**，避免了意外启动和潜在的硬件冲突，实现了真正的**硬件级故障安全**。

3.  **全链路物理断电 (Total Power Gating):**
    *   系统中的每一个非核心元件（12V升压模块、墨水屏、湿度传感器），其电源VCC都由独立的P-MOSFET进行物理层面的开关控制，实现真正的零待机功耗。

4.  **模块化热插拔能源补给 (Modular Hot-Swappable Energy Replenishment):**
    *   太阳能充电系统被设计为一个**可选的、可热插拔的外部模块**。这使得HydroSense V2.1具备双重工作模式：在室内使用时，不连接太阳能板，它是一个纯粹的超低功耗设备；在户外部署时，接上太阳能模块，它则升级为一个能量自持系统。
    *   **安全集成：** 遵循**“单一保护入口”**原则，太阳能充电模块的输出端与HydroSense主板的用电输入端**并联**在TP4056保护板的`OUT+`和`OUT-`上。这确保了无论是USB充电、太阳能充电，还是系统放电，都处于同一个保护电路的监控之下，万无一失。

#### **系统精密运行周期详解**

系统的运行分为两个并行的、互不干扰的逻辑流：

**A) 浇水任务逻辑流 (由ESP32主动控制):**
这是一个从“深度沉睡”到“哨兵巡逻”，再到“指挥官行动”的事件驱动闭环。

*   **阶段一：深度沉睡 (Deep Sleep - 系统的基准态)**
    *   系统的常态。总静态功耗被稳定地控制在**10微安以内**。

*   **阶段二：“哨兵”的低功耗巡逻 (ULP's Low-Power Patrol)**
    *   由RTC定时器（例如，每30分钟）仅唤醒ULP协处理器。
    *   ULP执行精简程序：打开**3.3V**供电的湿度传感器电源 -> ADC读数 -> 关闭传感器电源 -> 内部比较湿度值。
    *   **决策：** 若湿度正常，ULP直接返回休眠；若湿度低于阈值，ULP唤醒主CPU“指挥官”。

*   **阶段三：“指挥官”的精准行动 (Main CPU's Precision Action)**
    *   主CPU醒来后，根据预设模式，执行完整的、安全的浇水序列（通告->启动动力->安全浇水->安全停止->关闭动力->最终报告），随后立即返回深度睡眠。

**B) 能量补充逻辑流 (被动、持续进行):**
这是一个独立于浇水任务的后台进程，只要太阳能模块被连接，它就会自动运行。

*   **条件：** 太阳能模块已插入，且太阳能板接收到有效光照（输入电压 > 6.5V）。
*   **过程：** CN3795模块自动启动，其MPPT功能开始实时追踪太阳能板的最大功率点，将转换后的电能，通过TP4056保护板，安全地为18650电池组充电。
*   **状态：** 充电过程中，模块上的充电指示灯会亮起。当电池充满（被TP4056的保护电路检测到），或光照消失，充电过程会自动停止。