## **项目：HydroSense - 能量自持型智能浇水系统**

### **项目技术与运行逻辑概述**

#### **项目愿景与设计哲学**

HydroSense 旨在成为一个能够实现**能量自持 (Energy Self-Sufficient)**、达成“永久续航”级别的智能植物养护终端。其设计哲学融合了**极致的低功耗**与**高效的能量采集**，通过“哨兵-指挥官”协同架构将系统待机功耗降至微安级，同时利用模块化的太阳能系统在后台静默地补充能量，形成一个完美的能量闭环。

#### **核心技术架构**

1.  **“哨兵-指挥官”双处理器协同 (ULP & Main CPU):**
    *   系统的核心运行模式。**指挥官 (Main CPU)** 默认沉睡，**哨兵 (ULP)** 以纳瓦级功耗周期性巡逻，仅在必要时唤醒指挥官，从根本上杜绝了待机状态下的能源浪费。

2.  **鲁棒的启动与故障安全设计 (Robust Startup & Fault-Safe Design):**
    *   这是本设计的关键亮点。通过为所有P-MOSFET电源开关配备**~2kΩ的强上拉电阻**，我们确保了在MCU上电初始化的数百毫秒“空窗期”内，能够强制覆盖ESP32引脚约1.05V的默认弱低电平状态。这保证了所有受控外设在上电瞬间**绝对处于关闭状态**，实现了真正的**硬件级故障安全**。

3.  **全链路物理断电 (Total Power Gating):**
    *   系统中的每一个非核心元件（12V升压模块、墨水屏、湿度传感器），其电源VCC都由独立的P-MOSFET进行物理层面的开关控制，实现真正的零待机功耗。

4.  **模块化热插拔能源补给 (Modular Hot-Swappable Energy Replenishment):**
    *   太阳能充电系统被设计为一个**可选的、可热插拔的外部模块**。其遵循 **“单一保护入口”** 原则，确保无论是USB充电、太阳能充电，还是系统放电，都处于同一个保护电路的监控之下，万无一失。

5.  **分层式交互与智能生态 (Layered Interaction & Smart Ecosystem):**
    *   系统超越了简单的自动化设备，通过物理开关、旋转编码器和墨水屏的组合，提供了一个分层的、功能丰富的交互模型。它不仅能自主运行，还能在需要时转变为一个强大的诊断与控制中心，并通过Wi-Fi连接云端，实现NTP时间同步和LLM驱动的智能分析功能，构成一个小型智能生态。

#### **系统运行模式详解**

系统的运行由一个三掷物理开关严格定义，确保了模式之间的清晰界定和绝对安全。

**A) `RUN` (运行模式) - 自主低功耗循环**

这是系统的默认工作状态，旨在实现无人值守下的永久续航。

*   **阶段一：深度沉睡 (Deep Sleep - 系统的基准态)**
    *   系统的常态。主CPU完全休眠，总静态功耗被稳定地控制在**10微安以内**。

*   **阶段二：“哨兵”的低功耗巡逻 (ULP's Low-Power Patrol)**
    *   由RTC定时器（例如，每30分钟）仅唤醒ULP协处理器。
    *   ULP执行精简程序：打开传感器电源 -> ADC读数 -> 关闭传感器电源 -> 内部比较湿度值。
    *   **决策：** 若湿度正常，ULP直接返回休眠；若湿度低于阈值，ULP唤醒主CPU“指挥官”。

*   **阶段三：“指挥官”的精准行动 (Main CPU's Precision Action)**
    *   主CPU醒来后，根据预设模式，执行完整的、安全的浇水序列，更新墨水屏上的“状态仪表盘”快照，记录关键数据点到闪存，随后立即返回深度睡眠。

*   **外部唤醒源:**
    *   **模式切换:** 切换物理开关会立即唤醒主CPU，使其进入新模式的逻辑。
    *   **手动刷新:** 用户可通过单击编码器按键，随时从深度睡眠中唤醒设备，强制刷新一次仪表盘以获取最新状态，随后设备自动返回休眠。

**B) `INTERACTIVE` (交互模式) - 诊断与控制中心**

在此模式下，系统保持唤醒，屏幕点亮，转变为一个功能丰富的诊断与控制中心，等待用户通过旋转编码器进行指令输入。

*   **数据洞察与可视化:**
    *   **实时数据:** 在参数设置界面（如调整浇水阈值时）实时显示传感器读数，为用户的决策提供即时上下文。
    *   **历史图表:** 系统从闪存中读取历史数据点，生成并显示湿度与电池电压的历史变化折线图，帮助用户理解长期趋势。

*   **智能分析 (LLM Powered):**
    *   **植物顾问:** 用户可触发“AI健康报告”功能。设备将收集的上下文数据（植物类型、湿度趋势等）发送至云端，调用大语言模型(LLM)进行分析，并将返回的、人类可读的自然语言诊断建议显示在屏幕上。

*   **高级功能与设置:**
    *   **手动控制:** 提供安全的、有时间限制的手动浇水功能。
    *   **系统设置:** 包括设定浇水阈值、选择植物类型等核心参数。
    *   **硬件校准:** 提供向导式的传感器校准流程。
    *   **NTP时间同步:** 支持“机会性”的网络时间同步，为所有日志数据提供精确的时间戳。

**C) `OFF` (关机模式) - 安全维护**

系统进入最深度的休眠或等待物理断电，所有活动逻辑停止。用于更换电池、搬运花盆、长期存放等场景。切换到此模式时，屏幕会刷新一次显示关机信息。

#### **并行逻辑流：能量补充**

这是一个独立于主控运行模式的、被动的硬件级进程，只要满足条件就会自动运行。

*   **条件：** 太阳能模块已插入，且太阳能板接收到有效光照。
*   **过程：** CN3795 MPPT模块自动启动，实时追踪最大功率点，将采集的能量通过TP4056保护板安全地为电池组充电。
*   **状态：** 充电过程独立进行，直到电池充满或光照消失。