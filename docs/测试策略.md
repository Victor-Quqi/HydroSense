# HydroSense 测试策略

## 概述

采用轻量级硬件在环（HIL）测试策略，通过测试模式和串口CLI实现高效验证。

## 核心架构

**编译时隔离**
- `#ifdef TEST_MODE` 宏完全隔离测试代码
- 生产版本零性能影响
- PlatformIO构建配置控制

**测试模块**
```
src/test/
├── test_mode.h/cpp    # 测试模式管理
└── test_cli.h/cpp     # 串口CLI接口
```

## CLI命令集 (设计原则)

CLI命令集的设计应遵循简洁、直观的原则，并覆盖以下几类核心功能，具体的命令格式在开发HAL层时定义。

*   **状态查询**: 提供获取系统当前完整状态（如传感器读数、电源状态、模式等）的命令。
*   **硬件控制**: 提供对每一个独立硬件模块（如电源门、执行器、显示屏）进行开关、读写和控制的能力。
*   **输入模拟**: 提供模拟各种外部输入（如传感器数值、按键事件）的命令，用于在不受物理条件限制的情况下测试上层逻辑。
*   **逻辑触发**: 提供手动触发关键业务逻辑（如ULP决策、主CPU的浇水流程）的命令，用于分步调试。

## 自动化测试流程

测试流程依赖于项目根目录下的 `run_test.py` 脚本，该脚本提供了两种核心测试模式：

1.  **被动观测模式 (Passive Observation)**
    *   **用途**: 监控设备上电后的初始化序列或持续运行时的日志输出。
    *   **命令**: `python run_test.py --port <串口号> --timeout <秒数>`
    *   **行为**: 脚本会持续打印所有串口输出，直到超时后自动退出。

2.  **主动执行模式 (Active Execution)**
    *   **用途**: 向设备发送特定命令并验证其响应，是功能测试的核心。
    *   **命令**: `python run_test.py --port <串口号> --command "<命令>"`
    *   **行为**: 脚本发送命令后，会等待设备返回 `<<EOT>>` (End of Transmission) 信标。收到信标后，脚本会立即成功退出。如果超时仍未收到信标，则会报错退出。

**典型测试示例:**

```bash
# 观测设备启动日志，持续5秒
python run_test.py --timeout 5

# 向设备发送ping命令，并等待pong和EOT信标
python run_test.py --command "ping"

# 测试echo功能
python run_test.py --command "echo Hello"
```

## 配置参数

```cpp
#define TEST_CLI_BAUD_RATE 115200   // 串口波特率
//待补充
```

## 构建测试

```bash
# 编译并上传 test 环境的固件
pio run -e test --target upload

# 使用测试脚本与设备交互
python run_test.py --command "ping"
```

## 优势

- 低成本、高效率
- 真实硬件验证
- AI友好的文本接口
- 测试代码完全隔离