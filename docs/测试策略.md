# HydroSense 测试策略

## 概述

采用轻量级硬件在环（HIL）测试策略，通过 `#ifdef TEST_MODE` 宏隔离测试代码，使用串口CLI进行验证。

## 核心架构

```
src/test/
├── test_cli.h/cpp               # CLI输入处理
├── test_command_registry.h/cpp  # 命令注册
├── test_commands_core.h/cpp     # 核心命令 (echo, help)
├── test_commands_hal.h/cpp      # HAL命令 (电源、传感器、执行器)
└── test_mode.h/cpp              # 测试模式管理
```

## 核心命令示例

所有命令均通过CLI执行。使用 `help` 命令可查看完整、最新的命令列表及其详细用法。

```bash
# 查看所有可用命令
help

# 查看特定命令的详细用法
help power

# 控制传感器电源
power sensor on

# 读取所有传感器数据
read all

# 运行水泵 (功率150, 持续2秒)
pump run 150 2000
```

## 测试流程

使用 `run_test.py` 脚本：

```bash
# 编译上传
pio run -e test --target upload

# 被动观测（可选，查看启动日志）
python run_test.py --timeout 5

# 主动测试（发送命令）
python run_test.py --command "要测试的命令"

# 多命令测试（使用分号分隔）
python run_test.py --command "cmd1; cmd2; cmd3"
```

## 优势

- 低成本、高效率
- 真实硬件验证
- 测试代码完全隔离
- AI友好的文本接口