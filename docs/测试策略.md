# HydroSense 测试策略

## 概述

采用轻量级硬件在环（HIL）测试策略，通过测试模式和串口CLI实现高效验证。

## 核心架构

**编译时隔离**
- `#ifdef TEST_MODE` 宏完全隔离测试代码
- 生产版本零性能影响
- PlatformIO构建配置控制

**测试模块**
```
src/test/
├── test_mode.h/cpp    # 测试模式管理
└── test_cli.h/cpp     # 串口CLI接口
```

## CLI命令集

**状态查询**
- `status` - 获取设备状态快照

**硬件控制**
- `gate <target> <on|off>` - 电源门控制
- `pump <on|off> [duration]` - 水泵控制
- `valve <on|off>` - 电磁阀控制

**模拟输入**
- `mock moisture <value>` - 模拟湿度读数
- `mock voltage <value>` - 模拟电池电压

**逻辑触发**
- `trigger <ulp|main>` - 触发ULP或主CPU逻辑

## 自动化测试流程

1. **场景设置** - 使用mock命令创建虚拟环境
2. **逻辑触发** - 使用trigger命令启动决策
3. **状态验证** - 使用status命令监控变化
4. **结果分析** - 验证行为符合预期

## 配置参数

```cpp
#define TEST_CLI_BUFFER_SIZE 128    // 命令缓冲区
#define TEST_CLI_BAUD_RATE 115200   // 串口波特率
#define TEST_CMD_TIMEOUT 5000       // 命令超时
```

## 构建测试

```bash
pio run --target upload --build-flag "-D TEST_MODE"
pio device monitor
```

## 优势

- 低成本、高效率
- 真实硬件验证
- AI友好的文本接口
- 测试代码完全隔离