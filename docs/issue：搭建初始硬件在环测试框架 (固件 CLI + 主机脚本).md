#### **目标**

创建项目初始的、功能完备的硬件在环（HIL）测试框架。该框架由两部分组成：1) 一个在设备上运行的、**能发出完成信标**的固件命令处理器；2) 一个在主机上运行的、**支持智能混合模式**的通用 Python 测试脚本。

#### **验收标准**

**第一部分：主机端通用测试脚本 (`run_test.py`)**

1.  **脚本接口:**
    *   项目根目录下存在 `run_test.py`。
    *   接受可选参数 `--port`（默认COM7）, `--timeout`（默认30s）, `--command`, `--delay`（默认0s）。

2.  **智能模式验证:**
    *   **被动观测模式:** 当**不提供** `--command` 参数时，脚本的**唯一退出条件是 `--timeout`**。它会持续监控并打印所有串口输出，直到超时。
    *   **主动执行模式:** 当**提供** `--command` 参数时，脚本的**主要退出条件是接收到 `<<EOT>>\n` 信标**。`--timeout` 在此模式下作为安全保障，如果超时仍未收到信标，脚本应报错退出。

3.  **效率验证:**
    *   运行 `python run_test.py --timeout 30 --command "ping"`。脚本的执行时间应远小于 30 秒，在收到 `pong\n<<EOT>>\n` 响应后应几乎立即退出。

**第二部分：固件端命令处理器**

1.  **构建环境:**
    *   在 `platformio.ini` 中定义 `[env:test]` 并包含 `-DTEST_MODE` 标志。

2.  **代码结构:**
    *   测试代码位于 `src/test/` 目录，并通过 `#ifdef TEST_MODE` 引入。

3.  **功能与信标验证:**
    *   **命令处理后必须发送信标。**
    *   接收 `ping\n` -> 响应 `pong\n`，然后必须紧接着响应 `<<EOT>>\n`。
    *   接收 `echo hello\n` -> 响应 `hello\n`，然后必须紧接着响应 `<<EOT>>\n`。
    *   接收一个**未定义**的命令 (如 `foo\n`) -> 响应错误信息 (如 `Error: Unknown command\n`)，然后也**必须**紧接着响应 `<<EOT>>\n`。这确保了任何命令输入都有一个确定的结束。

**第三部分：端到端集成验证**

1.  **启动观测:** 执行 `python run_test.py --timeout 3` (无 command) 必须能成功捕获到固件启动时打印的初始化信息。
2.  **命令交互:** 执行 `python run_test.py --timeout 5 --command "echo HydroSense"` 必须能成功捕获到返回的 `HydroSense\n<<EOT>>\n` 字符串，并立即退出。