# HydroSense 项目报告大纲

---

## Abstract

HydroSense 是一个基于 ESP32-S3 的智能植物养护系统。系统能够自动监测土壤湿度并执行浇水，同时提供 LLM 驱动的对话功能，用户可以通过旋转编码器与植物进行自然语言交互。

---

## 1. Introduction

### 1.1 背景

植物养护需要持续关注土壤状态、定期浇水。对于忙碌的现代人，容易遗忘或过度浇水。

### 1.2 项目目标

设计一个智能植物养护助手：
- 自动监测土壤湿度，在需要时自动浇水
- 低功耗设计，适合长期无人值守运行
- 提供直观的状态显示
- （亮点）支持与植物"对话"，获取养护建议

**一句话概括**：一个可以放在阳台上几个月不用管、还能和你聊天的智能花盆。

### 1.3 系统概述

```
┌─────────────────────────────────────────────────┐
│                  HydroSense                     │
├─────────────────────────────────────────────────┤
│  输入        │  处理           │  输出          │
│  ─────       │  ─────          │  ─────         │
│  土壤湿度传感器 │  ESP32-S3      │  水泵（浇水）   │
│  电池电压检测  │  三模式状态机   │  墨水屏（显示） │
│  旋转编码器   │  LLM 连接器     │  对话响应      │
│  模式开关     │                │               │
└─────────────────────────────────────────────────┘
```

---

## 2. Detail Design

### 2.1 系统架构

#### 四层架构

```
┌─────────────────────────────────────┐
│    main.cpp（模式协调与切换）        │
├─────────────────────────────────────┤
│    Services 服务层                  │
│    WiFi | LLM | Config | Time       │
├─────────────────────────────────────┤
│    Managers 业务层                  │
│    Sensor | Power | Actuator | UI   │
├─────────────────────────────────────┤
│    HAL 硬件抽象层                   │
│    GPIO | ADC | SPI | LEDC | RTC    │
└─────────────────────────────────────┘
```

**为什么分层**：
- HAL 层隔离硬件差异，更换芯片只需修改 HAL
- Manager 层封装业务逻辑，如"读取湿度"包含：开电源→等待稳定→ADC采样→关电源
- Service 层处理高级功能（网络、存储、时间同步）
- main.cpp 只负责模式切换，不包含业务逻辑

#### 三模式状态机

| 模式 | 场景 | 行为 |
|------|------|------|
| **OFF** | 长期不用 | 深度睡眠，所有外设断电 |
| **RUN** | 日常运行 | 定时检测湿度→自动浇水→更新屏幕 |
| **INTERACTIVE** | 用户交互 | 启用 WiFi 和 LLM，支持菜单操作和对话 |

模式通过物理三档开关切换，硬件级可靠。

---

### 2.2 硬件设计

#### 2.2.1 传感器与执行器

| 组件 | 型号/规格 | 接口 |
|------|----------|------|
| 土壤湿度传感器 | 电容式 | ADC (GPIO 4) |
| 电池电压检测 | 分压电阻 | ADC (GPIO 7) |
| 水泵 | 12V 直流泵 | PWM (GPIO 12) |
| 显示屏 | 2.9寸墨水屏 296×128 | SPI |
| 输入 | 旋转编码器 + 按键 | GPIO + 中断 |

#### 2.2.2 电源管理

**问题**：传感器和外设即使在休眠时也会有漏电流

**方案**：P-MOSFET 物理电源门控
```
3.3V ──┬── MOSFET ──── 传感器电源
       │
       └── MOSFET ──── 12V升压模块（水泵）
       │
       └── MOSFET ──── 屏幕电源
```
- 低电平导通（P-MOSFET）
- 休眠时完全切断电流，而非依赖芯片的 sleep 模式

**直观对比：待机功耗**

| 设备 | 待机功耗 |
|------|---------|
| 笔记本电脑（睡眠） | ~2000 mW |
| 智能手机（待机） | ~500 mW |
| 智能手表 | ~50 mW |
| 蓝牙耳机充电盒 | ~5 mW |
| **HydroSense（OFF模式）** | **< 1 mW** |

→ 比蓝牙耳机充电盒还省电，理论上一块 18650 电池可以待机**数年**

#### 2.2.3 显示屏

使用 2.9 寸墨水屏（E-Paper），分辨率 296×128。

**为什么选墨水屏**：
- **断电保持**：屏幕内容在断电后依然保留，不需要持续供电
- **阳光下可读**：反射式显示，户外也能看清
- **极低功耗**：只有刷新时才耗电

**直观对比：显示功耗**

| 显示技术 | 静态显示功耗 |
|---------|-------------|
| LCD 屏幕 | 持续耗电（背光） |
| OLED 屏幕 | 持续耗电（像素发光） |
| **墨水屏** | **0（断电保持）** |

→ 植物养护场景下，屏幕大部分时间是静态显示，墨水屏是最优选择

#### 2.2.4 输入处理

旋转编码器支持三种操作：
- **旋转**：菜单选择、数值调节
- **单击**：确认
- **双击**（<325ms）：返回上级
- **长按**（>1500ms）：特殊操作

采用中断-标志模式：ISR 只设置标志，主循环处理逻辑，避免在中断中执行复杂操作。

#### 2.2.5 BOM 与成本分析

**原型机物料成本**（详见附录）：

| 类别 | 主要元器件 | 成本 |
|------|-----------|------|
| 核心与电源 | ESP32-S3、18650电池×2、太阳能充电模块、LDO、MOSFET | ¥72.73 |
| 传感与显示 | 土壤湿度传感器、墨水屏、旋转编码器 | ¥76.25 |
| 执行与连接 | 12V水泵、驱动模块、升压模块 | ¥36.56 |
| **总计** | | **¥185.54** |

**成本结构分析**：
- 墨水屏占比最高（¥65，约 35%）—— 量产可选更便宜的型号
- ESP32 开发板（¥22）—— 量产改用芯片直接贴片可降至 ¥10 以内
- 太阳能模块（¥22）—— 可选配，非必需

**直观对比：同类产品价格**

| 产品 | 价格 | 功能 |
|------|------|------|
| 小米花花草草检测仪 | ¥79 | 仅检测，不能浇水 |
| 懒人自动浇花器 | ¥30-80 | 定时浇水，无传感器 |
| 智能花盆（带 APP） | ¥200-500 | 检测+浇水+APP |
| **HydroSense 原型** | **¥186** | 检测+浇水+太阳能+**LLM对话** |

→ 原型成本已接近市售产品，且功能更丰富；量产后成本可降至 **¥100 以内**

---

### 2.3 软件实现

#### 2.3.1 RUN 模式：自动养护

```
loop() {
    每 5 秒：
        1. 开传感器电源
        2. 等待 100ms 稳定
        3. 读取 ADC 值
        4. 关传感器电源
        5. if (湿度 < 阈值) {
               开水泵电源
               PWM 驱动水泵
               等待设定时长
               关水泵电源
           }
        6. 更新墨水屏显示
}
```

屏幕显示仪表盘：湿度百分比、电池电压、上次浇水时间、系统状态。

#### 2.3.2 INTERACTIVE 模式：用户交互

状态机设计（6 个子状态）：
```
┌─────────────┐
│  主菜单     │ ←─────────────────────┐
├─────────────┤                      │
│ ▶ 系统状态  │──→ 显示传感器数据     ──┤
│   系统设置  │──→ 设置列表 → 编辑    ──┤
│   立即浇水  │──→ 确认 → 进度 → 结果 ──┤
│   聊天      │──→ LLM 对话界面      ──┘
└─────────────┘
```

进入 INTERACTIVE 模式时自动连接 WiFi（后台异步），为 LLM 功能做准备。

#### 2.3.3 配置持久化

使用 ESP32 的 NVS（Non-Volatile Storage）保存用户配置：
- 浇水阈值、时长、功率
- WiFi 凭据
- LLM API 配置

配置修改后立即写入 NVS，重启后自动恢复。

---

### 2.4 LLM 集成（亮点功能）

#### 2.4.1 设计动机

传统智能设备的交互是**单向通知**（"湿度低，请浇水"）。用户如果有疑问，需要自己查资料：
- "现在湿度 45%，对我的多肉来说够吗？"
- "我要出差一周，它能撑住吗？"
- "叶子有点发黄是什么原因？"

HydroSense 通过集成 LLM，支持**双向对话**，用户可以直接提问。

#### 2.4.2 交互设计：Option-based Dialogue

**问题**：嵌入式设备没有键盘，用户无法输入文字

**方案**：LLM 每次返回**回复 + 3 个后续选项**，用户用旋钮选择

```
┌─────────────────────────────────────┐
│  🌱 "I'm feeling good! Soil        │
│      moisture is at 65%."          │
├─────────────────────────────────────┤
│  ▶ Do you need water?              │  ← 旋钮选择
│    Tell me about your health       │
│    Any care tips for this week?    │
└─────────────────────────────────────┘
```

**闭环**：
1. 用户选择一个选项 → 作为 user message 发送
2. LLM 返回新回复 + 新的 3 个选项
3. 对话可以无限延续

**直观对比：嵌入式设备上的 AI 交互**

| 方案 | 输入方式 | 输入时间 | 门槛 |
|------|---------|---------|------|
| 语音助手 | 说话 | 3-5秒 | 需要麦克风+语音识别 |
| 手机 App | 打字 | 10-30秒 | 需要手机 |
| **Option-based** | 转旋钮 | **1秒** | 只需一个编码器 |

→ 这种设计让 LLM 对话可以在**任何只有简单输入设备的嵌入式系统**上实现

#### 2.4.3 上下文增强（Context Augmentation）

LLM 本身不知道植物的实际状态。解决方案：将传感器数据和系统状态注入到 System Prompt 中。

**构建的上下文**：
```
messages: [
  {
    role: "system",
    content: "You are a plant assistant. You can sense the real
              physical state of the plant through sensors..."
  },
  {
    role: "system",
    content: "Current sensor readings:
              - Soil moisture: 2521 (ADC raw) = 65%
              - Battery: 3.85V (Good)
              - Last watering: 2 hours ago

              System config:
              - Watering threshold: 1500
              - Plant type: Succulent"
  },
  {
    role: "system",
    content: "Recent system logs:
              [INFO] Watering completed
              [INFO] Sensor reading: 2521"
  },
  // 对话历史（最近 5 轮）
  { role: "user", content: "How are you?" },
  { role: "assistant", content: "I'm doing well..." },
  // 当前用户消息
  { role: "user", content: "Do you need water?" }
]
```

**效果**：AI 的回答会基于真实的传感器数据，而不是泛泛而谈。

#### 2.4.4 响应格式控制

要求 LLM 返回结构化 JSON：
```json
{
  "response": "I'm doing well! The soil is nicely moist at 65%.",
  "options": [
    "Do you need water?",
    "Any care tips?",
    "Tell me a plant joke"
  ]
}
```

**容错处理**：
- 如果 LLM 返回纯文本：提取文本作为 response，使用默认选项
- 如果 JSON 解析失败：显示错误信息，使用 fallback 选项
- 如果网络超时（30s）：提示用户检查网络

#### 2.4.5 对话历史

```cpp
struct ConversationTurn {
    char user_msg[128];
    char plant_msg[256];
    char options[3][64];
    uint32_t timestamp;
};
```
- 内存中保留最近 5 轮
- 持久化到 SPIFFS（/spiffs/history.json）
- 每次请求时将历史加入 messages 数组

---

## 3. Result and Discussion

### 3.1 功能验证

| 功能 | 状态 | 备注 |
|------|------|------|
| 自动湿度检测 | ✅ | 5秒间隔 |
| 自动浇水 | ✅ | 低于阈值触发 |
| 墨水屏显示 | ✅ | 仪表盘 + 菜单 |
| WiFi 连接 | ✅ | 支持 WPA2-PSK 和企业网络 |
| LLM 对话 | ✅ | 多轮对话 + 上下文增强 |
| 配置持久化 | ✅ | NVS 存储 |

### 3.2 性能数据

| 指标 | 数值 | 直观理解 |
|------|------|---------|
| LLM 响应时间 | 2-3 秒 | 比人打字问问题还快 |
| OFF 模式功耗 | < 1 mW | 18650 电池理论待机数年 |
| 屏幕全刷新 | ~2 秒 | 墨水屏特性，可接受 |
| 屏幕部分刷新 | ~0.5 秒 | 菜单操作流畅 |
| 代码规模 | ~8000 行 | 完整的嵌入式系统 |

### 3.3 局限性

- LLM 功能依赖网络连接
- 选项模式限制了完全自由的对话（但适合嵌入式场景）
- 当前版本 RUN 模式未使用 ULP 协处理器，功耗可进一步优化

---

## 4. Conclusion

HydroSense 实现了一个功能完整的智能植物养护系统：

1. **自动化养护**：基于湿度阈值的自动浇水，解放用户双手
2. **极致低功耗**：MOSFET 电源门控 + 墨水屏，待机功耗比蓝牙耳机还低
3. **模块化架构**：四层设计，~8000 行代码，便于维护和扩展
4. **LLM 对话**：Option-based Dialogue 让用户只需转动旋钮就能和植物聊天

**核心价值**：把"每天惦记着浇水"变成"几个月不用管"，把"看数据猜状态"变成"直接问它"。

### Future Work

#### 技术扩展

**硬件扩展**（架构已预留）：
- 营养液施肥模块（再加一路 MOSFET + 蠕动泵）
- 光照传感器（ADC 接口）
- 温湿度传感器（I2C 接口）
- 多盆联控（ESP-NOW 或 WiFi Mesh）

→ 四层架构的好处：加新传感器只需在 HAL 层加驱动，Manager 层加业务逻辑，上层无需改动

**云端集成**：
- 数据上传到云端，长期趋势分析
- 手机 APP 远程查看状态、远程浇水
- 远程 LLM 对话（不在设备旁也能和植物聊天）
- 多设备统一管理面板

#### 开源生态

项目已开源：https://github.com/Victor-Quqi/HydroSense

**社区价值**：
- 硬件爱好者可以自己 DIY
- 开发者可以贡献新传感器驱动、新功能
- 教育场景：嵌入式开发、LLM 集成的学习案例

#### 商业模式展望

参考 n8n、Home Assistant 等开源项目的商业模式：

| 层级 | 用户 | 服务 |
|------|------|------|
| **免费自托管** | 技术爱好者 | 开源代码，自己搭建 |
| **付费云服务** | 普通用户 | 托管服务、APP、数据存储 |
| **企业版** | 农场/温室 | 批量管理、定制开发、技术支持 |

→ 开源不等于不赚钱，而是用社区扩大影响力，用增值服务变现

---

## References

- Espressif ESP-IDF Programming Guide
- Arduino-ESP32 Documentation
- LVGL Documentation
- OpenAI API Reference
- GxEPD2 E-Paper Library

---

## Appendix

- A. 系统架构图
- B. 硬件原理图
- C. LLM System Prompt 完整示例
- D. 关键代码片段
- E. 实物照片
