# HydroSense 项目报告大纲

---

## Cover Page

- 项目名称：HydroSense
- 副标题：基于 ESP32-S3 的智能植物养护系统
- 课程名称、学号、姓名、日期等

---

## Table of Contents

- 根据实际页码自动生成

---

## Abstract

- 英文摘要（3–5 句）：问题背景、方案概述、关键功能、主要结果/结论

---

## 1. Introduction

### 1.1 背景与动机

- 日常养护易遗忘/过度浇水，缺少“及时、可理解”的状态反馈
- 选择嵌入式终端：长期部署、低维护、可离线工作（基础功能）

### 1.2 项目目标与需求

- 自动监测土壤湿度，并在需要时自动浇水
- 低功耗/长期无人值守的设计目标
- 直观的本地状态展示与简单交互（旋钮 + 屏幕）
- 亮点功能：LLM 驱动的“植物助手”对话（可选、依赖网络）

### 1.3 系统概述

- 输入：土壤湿度、电池电压、旋转编码器、三档模式开关
- 处理：ESP32-S3（状态机 + 业务逻辑 + 网络/LLM）
- 输出：水泵控制、墨水屏 UI、对话反馈
- 三档模式：`OFF` / `RUN` / `INTERACTIVE`

### 1.4 主要贡献/亮点（概览）

- MOSFET 物理电源门控：从硬件层面降低外设漏电带来的待机损耗
- Option-based Dialogue：在“只有一个旋钮”的输入条件下实现可用的 LLM 交互
- 分层/模块化固件架构：便于扩展与演示（HAL / Managers / Services / UI）
- “技术深度 + 可视化叙事”：用对比表/流程图/功耗预算图等，让非专业读者也能快速理解

---

## 2. Detailed Design

### 2.0 创新点概览（建议放在本章开头）

- **硬件低功耗**：P-MOSFET 电源门控 + 墨水屏（静态 0 功耗显示）
- **硬件可靠性**：三档物理模式开关（硬件级确定性与抗故障）
- **软件架构**：四层结构（HAL / Managers / Services / UI）
- **LLM 交互**：Option-based Dialogue（回复 + 选项），结构化 JSON 响应
- **上下文增强**：将传感器/配置/时间/历史注入 prompt，让回答“贴合真实状态”
- **开发效率**：串口 CLI 测试模式与日志系统（便于快速演示/定位问题）

### 2.1 总体架构

- 四层架构与职责划分（配图/引用 `docs/ProjectReport/ARCHITECTURE.md`）
- 模块边界：硬件抽象、业务逻辑、网络/存储服务、UI 展示
- 可视化：系统框图（输入/处理/输出）、代码模块结构图（目录树/层次图）

### 2.2 工作模式与状态机

- `OFF`：深度睡眠 + 外设断电 + 外部唤醒
- `RUN`：周期采样 → 阈值判断 → 浇水 → 刷新显示（当前版本主 CPU 实现）
- `INTERACTIVE`：菜单/设置/聊天；按需启用 WiFi 与 LLM
- **低功耗架构设想**：`RUN` 的“哨兵-指挥官”架构（ULP 低功耗巡逻，必要时唤醒主 CPU）
- 可视化：三模式状态机图、交互模式子状态机图、关键事件时序图（唤醒/采样/浇水/刷新）

### 2.3 硬件设计（仅保留大纲级信息）

- 核心器件与连接关系（详细型号/引脚表放附录）
- 电源与功耗策略：哪些外设被门控、休眠前的 GPIO 处理策略（避免寄生供电）
- 执行器与安全：水泵驱动/供电保护/防水与故障风险（正文展开即可）
- 可视化：电源门控示意图（MOSFET 作为“电源闸门”）、关键器件照片/标注图、BOM 成本饼图

### 2.4 软件实现（仅保留大纲级信息）

- 采样流程：传感器上电 → 稳定 → ADC 采样 → 断电
- 校准与映射：湿/干标定点、原始 ADC → 百分比的计算逻辑
- 自动浇水策略：阈值、最小间隔、手动触发/防抖与保护
- 配置持久化：NVS（阈值、浇水参数、WiFi、LLM 配置等）
- 日志与存储：串口日志 +（可选）SPIFFS 文件
- 可视化：浇水控制流程图（flowchart）、关键数据结构图（配置/传感器数据/对话历史）

### 2.5 UI 与交互

- 墨水屏刷新策略：全刷 vs 局刷（速度/残影/功耗取舍）
- 旋钮交互：旋转选择、单击确认、返回/快捷操作（按实现情况描述）
- 可视化：UI 页面截图/示意图（仪表盘、菜单、设置、聊天）、交互动线图（用户操作→系统响应）

### 2.6 LLM 集成（亮点功能）

- 交互模型：Option-based Dialogue（适配受限输入）
- Prompt 结构：system prompt + 当前传感器读数 + 配置 +（可选）历史
- 解析与容错：优先 JSON；非 JSON/超时/断网时的降级行为
- 安全与隐私（正文展开）：API Key 处理、最小化上传数据、网络依赖说明
- 可视化：端到端对话链路图（UI→WiFi→HTTPS→LLM→解析→UI）、“无上下文 vs 有上下文”的回答对比示例

### 2.7 测试与调试支持

- 串口 CLI 测试模式：传感器/显示/输入/WiFi/LLM/配置的演示入口
- 指标采集与日志：用于复现实验与定位问题的数据项
- 可视化：测试命令截图/输出示例、日志片段示例

---

## 3. Results and Discussion

### 3.1 当前版本可演示功能

- 自动采样与阈值浇水（含最小间隔等保护逻辑，按实际实现描述）
- 墨水屏仪表盘/菜单交互
- WiFi 连接与基础网络能力（按实际支持情况描述）
- LLM 对话：选项式交互 + 上下文增强 +（可选）历史
- 配置保存/恢复（NVS）

### 3.2 评估与对比（面向高分写作）

- 功能对比：HydroSense vs 传统花盆/市售检测仪（功能矩阵表）
- 成本对比：原型成本结构（饼图）+ 与同类产品价格区间（对比表）
- 体验对比：传统“看数字猜状态” vs “直接问它”（对话截图/案例）
- 可靠性对比：物理模式开关 + 本地 UI vs 纯手机 App（场景对比表）

### 3.3 性能、功耗与续航（用“方法 + 图表”呈现）

- 延迟：UI 刷新与 LLM 往返时间（附测试条件与统计方式）
- 功耗与续航：
  - **功耗分解**：按状态拆分（`OFF` / `RUN` / `INTERACTIVE`）的功耗预算表（模块级：MCU、传感器、屏幕、水泵、WiFi/HTTPS）
  - **续航估算**：基于“典型工作循环”的能量预算（每天/每小时采样次数、浇水频次、刷新次数）→ 续航区间
  - **关键假设说明**：电池容量、升压效率、外设典型电流（datasheet）等
  - **低功耗设计亮点**：哨兵-指挥官（ULP）架构作为进一步降低 `RUN` 平均功耗的技术路线
- 可视化：功耗预算柱状图/桑基图、工作循环时间轴图、续航区间图（best/typical/worst）
- 写作策略：用“预算/估算/区间/敏感性分析”表述，避免给出无法严谨复现的单点“绝对值”；把计算过程与参数表放到附录，正文只给结论与图表。

---

## 4. Conclusion

- 达成的核心功能与亮点
- 关键取舍：时间驱动导致的功能裁剪（例如 ULP/云端未完成）

### Future Work

- 补齐 ULP “哨兵-指挥官” `RUN`，并完成功耗验证
- 增强稳健性：异常处理、看门狗、故障降级策略
- 云端/APP 与长期数据分析（如有需要）
- 扩展传感器与多设备联控

---

## References

- （大纲示例；正文需补齐）ESP32-S3 / ESP-IDF / Arduino-ESP32 官方文档
- 关键器件 datasheet（传感器、MOSFET、墨水屏、水泵/驱动、电池/充电模块等）
- 依赖库文档与版本信息（显示/网络/JSON/UI 等）
- LLM API 文档

---

## Appendix

- A. 系统-硬件总览图（可参考 `docs/系统-硬件总览图.md`）
- B. BOM 与成本
- C 关键代码片段（可选）
- D. Prompt/对话示例（可选）
- E. 实物照片
